#!/bin/bash

echo "installing required tools..."
go install github.com/mna/pigeon
if [ $? -ne 0 ]; then
  echo "...error"
fi
go install github.com/czcorpus/manabuild@latest
if [ $? -eq 0 ]; then
  echo "...done"
else
  echo "...error"
fi

echo "generating parser code..."
go generate ./cmd/service/fcs.go
if [ $? -eq 0 ]; then
  echo "...done"
else
  echo "...error"
fi


# check system and prepare env variables
eval $(manabuild -no-build)

cat > Makefile <<EOF
# Makefile content generated by configure
.PHONY: clean tools

all: test-and-build

build:
	@echo "building the project without running unit tests"
	@go generate ./cmd/service/fcs.go
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go build -o mquery-sru ./cmd/service

test-and-build:
	@echo "running unit tests and building the project"
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go test $(go list ./... | grep -v "github.com/czcorpus/mquery-sru/cmd/testing" | tr '\n' ' ')
	@go generate ./cmd/service/fcs.go
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go build -o mquery-sru ./cmd/service

tools:
	@echo "installing local dependencies"
	@go install github.com/mna/pigeon
	@go install github.com/czcorpus/manabuild@latest

manatee-src:
	manabuild -no-build

generate:
	@echo "generating query parser code"
	@go generate ./cmd/service/fcs.go

install:
	@mkdir -p /opt/mquery-sru
	@cp -f mquery-sru /opt/mquery-sru
	@cp -rf assets /opt/mquery-sru/assets
	@mkdir -p /opt/mquery-sru/handler/v12
	@mkdir -p /opt/mquery-sru/handler/v20
	@cp -rf handler/v12/templates /opt/mquery-sru/handler/v12/templates
	@cp -rf handler/v20/templates /opt/mquery-sru/handler/v20/templates
	@cp -rf scripts /opt/mquery-sru/scripts
	@ln -sf /opt/mquery-sru/scripts/systemd/mquery-sru-server.service /etc/systemd/system/mquery-sru-server.service
	@ln -sf /opt/mquery-sru/scripts/systemd/mquery-sru-worker-all.target /etc/systemd/system/mquery-sru-worker-all.target
	@ln -sf /opt/mquery-sru/scripts/systemd/mquery-sru-worker@.service /etc/systemd/system/mquery-sru-worker@.service
	@systemctl enable mquery-sru-server
	@systemctl enable mquery-sru-worker-all.target

clean:
	@systemctl disable mquery-sru-server
	@systemctl disable mquery-sru-worker-all.target
	@rm -rf /etc/systemd/system/mquery-sru-server.service
	@rm -rf /etc/systemd/system/mquery-sru-worker-all.target
	@rm -rf /etc/systemd/system/mquery-sru-worker@.service
	@rm -rf /opt/mquery-sru

test:
	@echo "running unit tests"
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go test $(go list ./... | grep -v "github.com/czcorpus/mquery-sru/cmd/testing" | tr '\n' ' ')

rtest:
	@echo "running unit tests with the -race setting"
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go test -race $(go list ./... | grep -v "github.com/czcorpus/mquery-sru/cmd/testing" | tr '\n' ' ')

itest:
	@echo "running integration tests"
	@CGO_CXXFLAGS="${CGO_CXXFLAGS}" CGO_CPPFLAGS="${CGO_CPPFLAGS}" CGO_LDFLAGS="${CGO_LDFLAGS}" go test -v ./cmd/testing --args http://localhost:8989/

build-docker-itest:
	docker-compose -f docker-compose-itest.yml build

run-docker-itest:
	docker-compose -f docker-compose-itest.yml up

EOF

echo "Configuration successful. Run make to build the project."